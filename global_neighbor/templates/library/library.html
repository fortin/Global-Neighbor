{% extends "base.html" %}
{% load static %}

{% block title %}Library{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/library.css' %}">

{# Figure out the correct login URL name at render time #}
{% url 'login' as login_url %}
{% if not login_url %}{% url 'account_login' as login_url %}{% endif %}

<div class="library-container">
  <h1 class="page-title">Library</h1>

  <div class="library-controls">
    <input type="text" id="library-search" placeholder="Search documents..." oninput="filterDocuments()">
    <select id="category-filter" onchange="filterDocuments()">
      <option value="">All Categories</option>
      {% for category in categories %}
        <option value="{{ category.name }}">{{ category.name }}</option>
      {% endfor %}
    </select>
    <input type="text" id="tag-filter" placeholder="Filter by tag..." oninput="filterDocuments()">

    <div class="view-toggle">
      <button id="thumb-view-btn" class="btn btn-secondary active" onclick="setLibraryView('thumbnails')">
        <i class="fa fa-th"></i>
      </button>
      <button id="list-view-btn" class="btn btn-secondary" onclick="setLibraryView('list')">
        <i class="fa fa-list"></i>
      </button>
    </div>
  </div>

  {% if request.user.role == 'creator' or request.user.is_superuser %}
  <button type="button" class="btn btn-primary upload-btn" onclick="openUploadModal()">
    <i class="fa-solid fa-upload"></i> Upload Document
  </button>
  {% endif %}

  <div id="document-list-container" class="thumbnail-view" style="margin-top: 1rem;">
    {% for doc in documents %}
      {% url 'document_detail' doc.id as doc_detail_url %}
      <div class="document-card"
           data-title="{{ doc.title|default_if_none:'Untitled Document' }}"
           data-author="{{ doc.author|default_if_none:'' }}"
           data-category="{{ doc.category.name|default_if_none:'' }}"
           data-tags="{% for tag in doc.tags.all %}{{ tag.name }}{% if not forloop.last %} {% endif %}{% endfor %}">

        <div class="card-header">
          {% if request.user.is_authenticated %}
            <a href="{{ doc_detail_url }}" class="document-title">
              <strong>{{ doc.title|default:'Untitled Document' }}</strong>
            </a>
          {% else %}
            <a href="{{ login_url }}?next={{ doc_detail_url|urlencode }}" class="document-title">
              <strong>{{ doc.title|default:'Untitled Document' }}</strong>
            </a>
          {% endif %}
          {% if doc.author %}
            <div class="doc-author">by {{ doc.author }}</div>
          {% endif %}
        </div>

        {% if doc.category %}
          <div class="doc-category">{{ doc.category.name }}</div>
        {% endif %}

        {# Tags removed from cards (kept in data-tags for filtering) #}

        <div class="doc-actions">
          {# Download: neighbor/creator/moderator OR superuser (must be authenticated) #}
          {% if request.user.is_authenticated and request.user.is_superuser
                or request.user.is_authenticated and request.user.role == 'neighbor'
                or request.user.is_authenticated and request.user.role == 'creator'
                or request.user.is_authenticated and request.user.role == 'moderator' %}
            <a href="{% url 'download_document' doc.id %}" class="action-btn" title="Download">
              <i class="fa fa-download"></i>
            </a>
          {% endif %}

          {# Edit/Delete: uploader OR superuser (must be authenticated) #}
          {% if request.user.is_authenticated and request.user == doc.uploaded_by
                or request.user.is_authenticated and request.user.is_superuser %}
            <a href="{% url 'edit_document' doc.id %}" class="action-btn" title="Edit metadata">
              <i class="fa fa-pen"></i>
            </a>
            <a href="{% url 'delete_document' doc.id %}" class="action-btn" title="Delete">
              <i class="fa fa-trash"></i>
            </a>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p>No documents available.</p>
    {% endfor %}
  </div>
</div>

{% include "library/library_upload_modal.html" %}

<script src="{% static 'js/library/library_upload_modal.js' %}"></script>
<script src="{% static 'js/library/library_controls.js' %}"></script>
{% endblock %}