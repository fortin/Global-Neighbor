{% extends "base.html" %}
{% load static %}

{% block title %}{{ document.title }}{% endblock %}

{% block content %}

{% url 'login' as login_url %}

<div class="document-detail-container">
  <h1 class="page-title">{{ document.title }}</h1>

  <p class="doc-meta">
    {% if document.author %}<strong>Author:</strong> {{ document.author }}<br>{% endif %}
    {% if document.source %}<strong>Source:</strong> {{ document.source }}<br>{% endif %}
    <strong>Downloads:</strong> {{ document.download_count }}
  </p>

  <div class="document-actions" style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
    {# Download: neighbor/creator/moderator OR superuser #}
    {% if request.user.is_authenticated %}
      {% if request.user.is_superuser or request.user.role == 'neighbor' or request.user.role == 'creator' or request.user.role == 'moderator' %}
        <a href="{% url 'download_document' document.id %}" class="btn btn-primary">
          <i class="fa fa-download"></i> Download
        </a>
      {% endif %}
    {% else %}
      <a href="{{ login_url }}?next={{ request.path|urlencode }}" class="btn btn-secondary">
        <i class="fa fa-sign-in-alt"></i> Log in to download
      </a>
    {% endif %}

    {# Edit/Delete: uploader OR superuser #}
    {% if request.user.is_authenticated %}
      {% if request.user == document.uploaded_by or request.user.is_superuser %}
        <a href="{% url 'edit_document' document.id %}" class="btn btn-secondary">
          <i class="fa fa-pen"></i> Edit
        </a>
        <a href="{% url 'delete_document' document.id %}" class="btn btn-secondary">
          <i class="fa fa-trash"></i> Delete
        </a>
      {% endif %}
    {% endif %}
  </div>

  {% if document.tags.all %}
    <div class="doc-tags-row" style="margin: 1rem 0;">
      <strong>Tags:</strong>
      <span class="doc-tags">
        {% for tag in document.tags.all %}
          <a class="tag-chip" href="{% url 'library' %}?tag={{ tag.name|urlencode }}" aria-label="Filter library by tag {{ tag.name }}">
          {{ tag.name }}
          </a>
        {% endfor %}
      </span>
    </div>
  {% endif %}

  <div class="pdf-viewer">
    <iframe src="{% url 'serve_document' document.id %}" width="100%" height="700" style="border: none;">
      This browser does not support PDFs. Please download the PDF to view it:
      <a href="{% url 'serve_document' document.id %}">Download PDF</a>
    </iframe>
  </div>

</div>
{% endblock %}