{% extends "base.html" %}
{% load static %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/blog.css' %}">
<link rel="stylesheet" href="{% static 'css/comments.css' %}">

<div class="form-page-container">
  <h1 class="form-title">{{ post.title }}</h1>

  <p class="timestamp-link">By {{ post.author }} on {{ post.created|date:"F j, Y" }}</p>

  {% if post.categories.exists %}
    <p><strong>Categories:</strong>
      {% for category in post.categories.all %}
        <a href="{% url 'blog:blog_index' %}?category={{ category.slug }}">{{ category.title }}</a>{% if not forloop.last %}, {% endif %}
      {% endfor %}
    </p>
  {% endif %}

  {% if post.tags.exists %}
    <p><strong>Tags:</strong>
      {% for tag in post.tags.all %}
        <a href="{% url 'blog:blog_index' %}?tag={{ tag.slug }}">{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}
      {% endfor %}
    </p>
  {% endif %}

  <div class="post-text">
    {{ post.content|linebreaksbr }}
  </div>

  {% if request.user == post.author or request.user.is_superuser or request.user.is_moderator %}
    <div style="margin-top: 1.5rem;">
      <a href="{% url 'blog:edit_blog_post' slug=post.slug %}" class="btn btn-secondary">
        <i class="fa fa-edit"></i> Edit Post
      </a>
      <button type="button" class="btn btn-danger" onclick="confirmDeletePost()">
        <i class="fa fa-trash"></i> Delete
      </button>
    </div>

    <!-- Delete confirmation modal -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <p>Are you sure you want to delete this post?</p>
        <form method="post" action="{% url 'blog:delete_blog_post' slug=post.slug %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Yes, delete</button>
          <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        </form>
      </div>
    </div>
  {% endif %}

  <hr>

  <section class="comments-section">
    <h2 class="comments-title">Comments</h2>

    {% if request.user.is_authenticated %}
      <form method="post" class="comment-form">
        {% csrf_token %}
        {{ comment_form.non_field_errors }}
        {{ comment_form.content.errors }}
        {{ comment_form.content }}
        <button type="submit" class="btn btn-primary">Post Comment</button>
      </form>
    {% else %}
      <p class="comment-login">You must be <a href="{% url 'login' %}?next={{ request.path }}">logged in</a> to post a comment.</p>
    {% endif %}

    <div class="comment-list">
      {% for comment in comments %}
        <div class="comment-card">
          <div class="comment-meta">
            <strong>{{ comment.author }}</strong>
            <span class="comment-timestamp">· {{ comment.created|date:"M d, Y H:i" }}</span>
          </div>
          <div class="comment-content">{{ comment.content|linebreaks }}</div>

          {% if request.user.is_authenticated %}
            <button class="reply-toggle" data-reply-id="{{ comment.id }}">Reply</button>
            <form method="post" class="reply-form hidden" id="reply-form-{{ comment.id }}">
              {% csrf_token %}
              <input type="hidden" name="parent_id" value="{{ comment.id }}">
              {{ comment_form.content }}
              <button type="submit" class="btn btn-secondary">Post Reply</button>
            </form>
          {% endif %}

          {% if request.user == comment.author or request.user.is_superuser or request.user.is_moderator %}
            <a href="{% url 'blog:edit_comment' comment_id=comment.id %}" class="reply-toggle">Edit</a>
          {% endif %}

          {% for reply in comment.replies.all %}
            <div class="comment-reply">
              <div class="comment-meta">
                <strong>{{ reply.author }}</strong>
                <span class="comment-timestamp">· {{ reply.created|date:"M d, Y H:i" }}</span>
              </div>
              <div class="comment-content">{{ reply.content|linebreaks }}</div>
            </div>
          {% endfor %}
        </div>
      {% empty %}
        <p>No comments yet. Be the first to contribute!</p>
      {% endfor %}
    </div>
  </section>

  <div style="margin-top: 1.5rem;">
    <a href="{% url 'blog:blog_index' %}" class="btn btn-secondary">Back to Blog</a>
  </div>
</div>

<!-- Modal + Reveal Toggle Scripts -->
<script>
  function confirmDeletePost() {
    document.getElementById("deleteModal").style.display = "block";
  }

  function closeDeleteModal() {
    document.getElementById("deleteModal").style.display = "none";
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".reply-toggle").forEach((btn) => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        const replyId = this.dataset.replyId;
        const form = document.getElementById(`reply-form-${replyId}`);
        form.classList.toggle("hidden");
      });
    });
  });
</script>

{% endblock %}